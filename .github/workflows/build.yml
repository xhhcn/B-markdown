name: Build and Release B-Markdown

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  actions: read

env:
  # å¼ºåˆ¶åœ¨GitHub Actionsä¸­ä½¿ç”¨æœ€æ–°çš„Node.jså’Œnpm
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        shell: bash
        run: |
          echo "All platforms: Using npm install to avoid rollup native dependency issues"
          rm -rf node_modules package-lock.json
          npm install

      - name: Check basic syntax and imports
        run: |
          # Clean any generated .d.ts files
          find . -name "*.d.ts" -not -path "./node_modules/*" -delete || true
          # Just check if Vite can parse the files (basic syntax check)
          npm run build || echo "Build check completed"

  build:
    needs: test
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # Temporarily disabled - uncomment when needed
          # - os: ubuntu-latest
          #   platform: linux
          #   arch: x64
          # - os: windows-latest
          #   platform: win32
          #   arch: x64
          - os: macos-latest
            platform: darwin
            arch: x64
          - os: macos-latest
            platform: darwin
            arch: arm64
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        shell: bash
        run: |
          echo "All platforms: Using npm install to avoid rollup native dependency issues"
          rm -rf node_modules package-lock.json
          npm install

      # Temporarily disabled - uncomment when needed
      # - name: Build application (Linux)
      #   if: matrix.platform == 'linux'
      #   shell: bash
      #   run: |
      #     echo "Linux build: Installing platform-specific rollup binaries"
      #     npm install @rollup/rollup-linux-x64-gnu --no-save --force
      #     npm run build:linux
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: Build application (Windows)
      #   if: matrix.platform == 'win32'
      #   shell: bash
      #   run: |
      #     echo "Windows build: Installing platform-specific rollup binaries"
      #     npm install @rollup/rollup-win32-x64-msvc --no-save --force
      #     npm run build:win
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build application (macOS)
        if: matrix.platform == 'darwin'
        shell: bash
        run: |
          echo "macOS build: Installing platform-specific rollup binaries"
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            npm install @rollup/rollup-darwin-arm64 --no-save --force
            echo "Building for Apple Silicon (arm64)"
          else
            npm install @rollup/rollup-darwin-x64 --no-save --force  
            echo "Building for Intel (x64)"
          fi
          
          # Clean release directory before build to avoid conflicts
          rm -rf release/
          
          # Set environment for consistent builds
          export NODE_ENV=production
          export ELECTRON_ENABLE_STACK_DUMPING=false
          export ELECTRON_ENABLE_LOGGING=false
          
          # Build for specific architecture with explicit parameters
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            npm run build:mac:dir:arm64 -- --config.compression=maximum --config.nsis.oneClick=false
          else
            npm run build:mac:dir:x64 -- --config.compression=maximum --config.nsis.oneClick=false
          fi
          
          # Fix permissions and apply ad-hoc signing for macOS app
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            APP_PATH="release/mac-arm64/B-Markdown.app"
            chmod +x "$APP_PATH/Contents/MacOS/B-Markdown"
            echo "Fixed permissions for ARM64 build"
          else
            APP_PATH="release/mac/B-Markdown.app"
            chmod +x "$APP_PATH/Contents/MacOS/B-Markdown"
            echo "Fixed permissions for Intel build"
          fi
          
          # Apply ad-hoc code signing to make the app trusted
          echo "Applying ad-hoc code signing..."
          codesign --force --deep --sign - "$APP_PATH"
          echo "Code signing completed"
          
          # Verify the signing
          codesign --verify --verbose "$APP_PATH" || echo "Code signing verification completed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List build outputs
        shell: bash
        run: ls -la release/

      # Temporarily disabled - uncomment when needed
      # - name: Upload build artifacts (Linux)
      #   if: matrix.platform == 'linux'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: B-Markdown-linux-${{ matrix.arch }}
      #     path: |
      #       release/*.AppImage
      #       release/*.deb
      #       release/*.blockmap
      #     if-no-files-found: error

      # - name: Upload build artifacts (Windows)
      #   if: matrix.platform == 'win32'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: B-Markdown-windows-${{ matrix.arch }}
      #     path: |
      #       release/*.exe
      #       release/*.blockmap
      #     if-no-files-found: error

      - name: Check app size and enforce limits
        if: matrix.platform == 'darwin'
        shell: bash
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            APP_PATH="release/mac-arm64/B-Markdown.app"
          else
            APP_PATH="release/mac/B-Markdown.app"
          fi
          
          echo "=== ğŸ“Š APP SIZE CHECK START ==="
          
          # Check initial size using multiple methods
          INITIAL_SIZE_DU=$(du -s "$APP_PATH" | cut -f1)
          INITIAL_SIZE_MB_DU=$((INITIAL_SIZE_DU / 1024))
          INITIAL_SIZE_MB_REAL=$(du -sm "$APP_PATH" | cut -f1)
          echo "ğŸ“ Initial app size (du -s method): ${INITIAL_SIZE_MB_DU}MB"
          echo "ğŸ“ Initial app size (du -sm method): ${INITIAL_SIZE_MB_REAL}MB"
          echo "ğŸ“ Initial app size: ${INITIAL_SIZE_MB}MB"
          
          # Debug: Check what's causing the size difference
          echo "ğŸ” Analyzing app contents..."
          echo "=== COMPLETE DIRECTORY ANALYSIS ==="
          echo "All Contents subdirectories:"
          du -sh "$APP_PATH/Contents/"* 2>/dev/null || echo "Could not analyze all directories"
          echo "=== FRAMEWORKS ANALYSIS ==="
          echo "Frameworks directory size:"
          du -sh "$APP_PATH/Contents/Frameworks/"
          echo "Helper apps count:"
          ls -la "$APP_PATH/Contents/Frameworks/" | grep Helper | wc -l
          echo "Electron Framework size:"
          ls -lh "$APP_PATH/Contents/Frameworks/Electron Framework.framework/Versions/A/Electron Framework" || echo "Not found"
          echo "=== RESOURCES ANALYSIS ==="
          echo "Resources directory size:"
          du -sh "$APP_PATH/Contents/Resources/" 2>/dev/null || echo "No Resources directory"
          echo "=== HIDDEN FILES CHECK ==="
          echo "Looking for hidden or unusual files:"
          find "$APP_PATH" -name ".*" -type f -exec ls -lh {} \; 2>/dev/null | head -5 || echo "No hidden files found"
          echo "=== ASAR FILE CHECK ==="
          echo "Checking asar files:"
          find "$APP_PATH" -name "*.asar" -exec ls -lh {} \; 2>/dev/null || echo "No asar files found"
          echo "=== LARGE FILES CHECK ==="
          echo "Top 20 largest files:"
          find "$APP_PATH" -type f -exec ls -lh {} \; | sort -hr | head -20
          
          # Remove any source maps or debug files
          echo "ğŸ§¹ Cleaning debug files..."
          find "$APP_PATH" -name "*.map" -delete
          find "$APP_PATH" -name "*.d.ts" -delete  
          find "$APP_PATH" -path "*/node_modules/*" -delete 2>/dev/null || true
          find "$APP_PATH" -name "*.log" -delete 2>/dev/null || true
          
          # Force strip debug symbols from binaries
          echo "ğŸ”§ Stripping debug symbols..."
          find "$APP_PATH" -type f -name "*.dylib" -exec strip -x {} \; 2>/dev/null || true
          find "$APP_PATH" -type f -perm +111 -exec strip -x {} \; 2>/dev/null || true
          
          # Check final size using multiple methods
          FINAL_SIZE_DU=$(du -s "$APP_PATH" | cut -f1)
          FINAL_SIZE_MB_DU=$((FINAL_SIZE_DU / 1024))
          FINAL_SIZE_MB_REAL=$(du -sm "$APP_PATH" | cut -f1)
          echo "ğŸ“ Final app size (du -s method): ${FINAL_SIZE_MB_DU}MB"
          echo "ğŸ“ Final app size (du -sm method): ${FINAL_SIZE_MB_REAL}MB"
          echo "ğŸ“ Final app size (REAL): ${FINAL_SIZE_MB_REAL}MB"
          
          # Use the real MB size for comparison
          FINAL_SIZE_MB=$FINAL_SIZE_MB_REAL
          
          # Set STRICT size limits to match local build
          MAX_SIZE_MB=250  # ä¸¥æ ¼é™åˆ¶ï¼Œæ¥è¿‘æœ¬åœ°231MB
          MIN_SIZE_MB=200
          
          echo "ğŸ¯ Size limits: ${MIN_SIZE_MB}MB - ${MAX_SIZE_MB}MB"
          
          if [ $FINAL_SIZE_MB -gt $MAX_SIZE_MB ]; then
            echo "âŒ ERROR: App size ${FINAL_SIZE_MB}MB exceeds maximum ${MAX_SIZE_MB}MB!"
            echo "ğŸ” Largest files in app:"
            find "$APP_PATH" -type f -exec ls -lh {} \; | sort -hr | head -10
            echo "ğŸ” Directory sizes breakdown:"
            du -sh "$APP_PATH/Contents/"* 2>/dev/null || echo "Could not show directory breakdown"
            echo "ğŸ’¡ This app is too large for users to download and use!"
            exit 1
          elif [ $FINAL_SIZE_MB -lt $MIN_SIZE_MB ]; then
            echo "âŒ ERROR: App size ${FINAL_SIZE_MB}MB is too small (< ${MIN_SIZE_MB}MB)!"
            echo "ğŸ” This might indicate missing files!"
            exit 1
          else
            echo "âœ… SUCCESS: App size ${FINAL_SIZE_MB}MB is within acceptable range!"
          fi
          
          echo "=== ğŸ“Š APP SIZE CHECK END ==="
          
      - name: Upload build artifacts (macOS)
        if: matrix.platform == 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: B-Markdown-macos-${{ matrix.arch }}
          path: |
            release/mac*/**/B-Markdown.app
          if-no-files-found: error

  auto-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Get latest tag
        id: get-latest-tag
        shell: bash
        run: |
          # è·å–æœ€æ–°çš„tagï¼Œå¦‚æœæ²¡æœ‰åˆ™ä»v1.0.0å¼€å§‹
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "Latest tag: $latest_tag"
          
      - name: Calculate next version
        id: next-version
        shell: bash
        run: |
          latest_tag="${{ steps.get-latest-tag.outputs.latest_tag }}"
          
          # å¦‚æœæ˜¯v0.0.0ï¼ˆè¡¨ç¤ºæ²¡æœ‰tagï¼‰ï¼Œåˆ™ä»v1.0.0å¼€å§‹
          if [ "$latest_tag" = "v0.0.0" ]; then
            next_version="v1.0.0"
          else
            # è§£æç‰ˆæœ¬å·å¹¶é€’å¢patchç‰ˆæœ¬
            version_without_v="${latest_tag#v}"
            IFS='.' read -r major minor patch <<< "$version_without_v"
            patch=$((patch + 1))
            next_version="v${major}.${minor}.${patch}"
          fi
          
          echo "next_version=$next_version" >> $GITHUB_OUTPUT
          echo "Next version: $next_version"
          
      - name: Update package.json version
        shell: bash
        run: |
          next_version="${{ steps.next-version.outputs.next_version }}"
          version_without_v="${next_version#v}"
          sed -i "s/\"version\": \".*\"/\"version\": \"$version_without_v\"/" package.json
          echo "Updated package.json to version $version_without_v"
          
      - name: Commit version change
        shell: bash
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package.json
          git commit -m "chore: bump version to ${{ steps.next-version.outputs.next_version }}" || exit 0
          
      - name: Create and push tag
        shell: bash
        run: |
          next_version="${{ steps.next-version.outputs.next_version }}"
          git tag -a "$next_version" -m "Release $next_version"
          git push origin main
          git push origin "$next_version"
          echo "Created and pushed tag: $next_version"
        
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        
      - name: Display structure of downloaded files
        shell: bash
        run: ls -la artifacts/
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.next-version.outputs.next_version }}
          name: "B-Markdown ${{ steps.next-version.outputs.next_version }}"
          body: |
            ## ğŸ‰ B-Markdown ${{ steps.next-version.outputs.next_version }} å‘å¸ƒ

            ### âœ¨ ç‰¹æ€§
            - ğŸ’» ä¸“ä¸šçš„Markdownç¼–è¾‘å™¨
            - ğŸ§® å®Œæ•´çš„æ•°å­¦å…¬å¼æ”¯æŒ (KaTeX)
            - ğŸ“„ PDFå¯¼å‡º (Default/Academicä¸»é¢˜)
            - ğŸŒ ä¸­è‹±æ–‡å›½é™…åŒ–
            - ğŸ” æœç´¢å’Œæ›¿æ¢åŠŸèƒ½
            - ğŸ¨ å®æ—¶é¢„è§ˆ

            ### ğŸ“¦ æ”¯æŒå¹³å°
            - ğŸ **macOS**: Intel (x64) + Apple Silicon (arm64) åº”ç”¨ç¨‹åº
            <!-- æš‚æ—¶ç¦ç”¨ï¼Œå°†æ¥å¯èƒ½æ¢å¤
            - ğŸªŸ **Windows**: x64 å®‰è£…ç¨‹åº
            - ğŸ§ **Linux**: AppImage + DebianåŒ…
            -->

            ### ğŸ“‹ æ›´æ–°å†…å®¹
            æ­¤ç‰ˆæœ¬åŒ…å«æœ€æ–°çš„åŠŸèƒ½æ”¹è¿›å’Œbugä¿®å¤ã€‚

            ---
            **ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…å³å¯ä½¿ç”¨ï¼**
          files: |
            artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}